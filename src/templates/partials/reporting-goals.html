<a href="#" id="new-goal-btn" class="btn btn-orange btn-md pull-right" style="position: fixed;top: 100%;right: 36px;z-index: 9999;margin-top: -81px;">New Goal</a>
{% for goal in goals %}
<div class="panel panel-white">
    <div class="panel-heading">Goal Report -  {{ goal.name }}
        <span class="pull-right">
            <a href="#" class="btn btn-xs btn-primary edit-goal" data-id="{{ goal.id }}">Edit</a>
            <a href="#" class="btn btn-xs btn-primary delete-goal" data-id="{{ goal.id }}">Delete</a>
        </span>
    </div>
    <div class="panel-body">
        <div class="col-lg-6 no-margins">
            <div class="ibox float-e-margins">
                <div class="ibox-content">
                    <canvas id="goal-{{ goal.id }}"></canvas>
                </div>
            </div>

        </div>
        <div class="col-lg-6 no-margins">
            <div class="ibox float-e-margins" id="report-goal-{{goal.id}}">

            </div>
        </div>
    </div>
</div>
{% endfor %}
<script>
    //daily visitors
    var goalData = {{ goalreport|json_encode|raw }};

    var chartLogic = function(data) {

        var dates = [];
        var datasets = [];

        return {
            data: data,
            totalVariationVisitors: {},
            formattedData: null,
            totalVisitors: 0,
            manipulate: function() {
                this.data.forEach(function (ele) {

                    var date = ele['ga:date'].toString();
                    dates[date.substring(6, 8) + "/" + date.substring(4, 6)] = true;
                    if (!datasets[ele['ga:eventLabel']]) {
                        datasets[ele['ga:eventLabel']] = []
                    }
                    datasets[ele['ga:eventLabel']].push(ele['ga:sessions']);

                });

                var data = {labels: Object.keys(dates), datasets: []};
                var bgColor = ["#26B99A", "#03586A"];
                var count = 0;
                for (var i in datasets) {
                    this.totalVariationVisitors[i] = eval(datasets[i].join('+'));
                    this.totalVisitors += this.totalVariationVisitors[i];
                    data.datasets.push({
                        fill:false,
                        lineTension: 0.1,
                        borderColor: bgColor[count],//"rgba(75,192,192,1)",
                        borderCapStyle: 'butt',
                        label: i.substring(i.lastIndexOf(":") + 1, i.length),
                        backgroundColor: bgColor[count],
                        data: datasets[i]
                    });
                    count++;
                }
                this.formattedData = data;
            },
            executeChart: function(id,type) {
                var ctx = document.getElementById(id);
                var self = this;
                var mybarChart = new Chart(ctx, {
                    type: type,
                    data: self.formattedData,

                    options: {
                        fill: false,
                        scales: {
                            yAxes: [{
                                ticks: {
                                    beginAtZero: true
                                }
                            }]
                        }
                    }
                });
            }


        }


    }
    if(goalData != null) {
        for (var goal_id in goalData) {
            if(goalData[goal_id] === null) {
                continue;
            }
            var lineChart = new chartLogic(goalData[goal_id]);
            lineChart.manipulate();
            lineChart.executeChart('goal-'+goal_id, 'line');

            console.log("Total Visitors: " + lineChart.totalVisitors);

            for (var vname in lineChart.totalVariationVisitors) {
                var var_traffic = lineChart.totalVariationVisitors[vname];

                console.log(vname +" : "+ var_traffic);
                $('#report-goal-'+goal_id).append('<div class="ibox-content"> \
                                        <div class="row"> \
                                            <div class="col-xs-6"> \
                                                <small class="stats-label">Name</small> \
                                                <h4 class="v-label">' + vname + '</h4> \
                                            </div> \
                                            <div class="col-xs-6"> \
                                                <small class="stats-label">Visitors / %</small> \
                                                <h4>' + var_traffic + ' / ' + (var_traffic * 100 / lineChart.totalVisitors).toFixed(2) + '%</h4> \
                                            </div> \
                                        </div> \
                                    </div>')

            }
        }
    }
</script>

<style>

</style>